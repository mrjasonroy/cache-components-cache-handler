name: Publish to npm

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha.*'
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

      - name: Build packages
        run: pnpm build

      - name: Run unit tests
        run: pnpm test

      - name: Install Playwright browsers
        run: pnpm --filter e2e-test-app exec playwright install --with-deps chromium

      - name: Build e2e app
        run: |
          cd apps/e2e-test-app
          pnpm build

      - name: Run e2e tests with memory cache
        run: |
          cd apps/e2e-test-app
          pnpm test:e2e

      - name: Build e2e app with Redis
        env:
          CACHE_HANDLER: redis
          REDIS_URL: redis://localhost:6379
        run: |
          cd apps/e2e-test-app
          pnpm build

      - name: Run e2e tests with Redis
        env:
          CACHE_HANDLER: redis
          REDIS_URL: redis://localhost:6379
        run: |
          cd apps/e2e-test-app
          pnpm test:e2e

  publish:
    needs: test
    runs-on: ubuntu-latest
    environment: publish # Requires manual approval before publishing
    permissions:
      contents: read
      id-token: write # Required for npm provenance and trusted publishing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify git tag matches package version
        run: |
          # Extract version from git tag (v16.0.0-alpha.0 -> 16.0.0-alpha.0)
          GIT_TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          # Get version from package.json
          PACKAGE_VERSION=$(node -p "require('./packages/cache-handler/package.json').version")

          echo "Git tag version: $GIT_TAG_VERSION"
          echo "Package.json version: $PACKAGE_VERSION"

          # Verify they match
          if [ "$GIT_TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ERROR: Version mismatch!"
            echo "Git tag: v$GIT_TAG_VERSION"
            echo "package.json: $PACKAGE_VERSION"
            echo "These must match. The git tag is the source of truth."
            exit 1
          fi

          echo "âœ… Versions match: $PACKAGE_VERSION"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Determine npm dist-tag
        id: dist_tag
        run: |
          VERSION=$(node -p "require('./packages/cache-handler/package.json').version")
          if [[ "$VERSION" == *"-alpha"* ]]; then
            echo "tag=alpha" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-beta"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-rc"* ]]; then
            echo "tag=rc" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          echo "Publishing with tag: $(cat $GITHUB_OUTPUT | grep tag= | cut -d= -f2)"

      - name: Publish to npm
        working-directory: packages/cache-handler
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --tag ${{ steps.dist_tag.outputs.tag }}

      - name: Verify published
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/cache-handler/package.json').version")
          DIST_TAG="${{ steps.dist_tag.outputs.tag }}"
          echo "âœ… Published @mrjasonroy/cache-components-cache-handler@$PACKAGE_VERSION"
          echo "ðŸ“¦ npm dist-tag: $DIST_TAG"
          npm view @mrjasonroy/cache-components-cache-handler@$PACKAGE_VERSION

      - name: Comment on release
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const version = require('./packages/cache-handler/package.json').version;
            const distTag = '${{ steps.dist_tag.outputs.tag }}';
            const releaseId = context.payload.release.id;

            let installCmd = `npm install @mrjasonroy/cache-components-cache-handler@${version}`;
            if (distTag !== 'latest') {
              installCmd += `\n# Or install by tag:\nnpm install @mrjasonroy/cache-components-cache-handler@${distTag}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: releaseId,
              body: `âœ… Successfully published to npm!\n\nðŸ“¦ **dist-tag**: \`${distTag}\`\n\n\`\`\`bash\n${installCmd}\n\`\`\`\n\nView on npm: https://www.npmjs.com/package/@mrjasonroy/cache-components-cache-handler/v/${version}`
            });
