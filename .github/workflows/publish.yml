name: Publish to npm

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha.*'
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: publish # Requires manual approval before publishing
    permissions:
      contents: write # Required for creating releases
      id-token: write # Required for npm provenance and trusted publishing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify git tag matches package version
        run: |
          # Extract version from git tag (v16.0.0-alpha.0 -> 16.0.0-alpha.0)
          GIT_TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          # Get version from package.json
          PACKAGE_VERSION=$(node -p "require('./packages/cache-handler/package.json').version")

          echo "Git tag version: $GIT_TAG_VERSION"
          echo "Package.json version: $PACKAGE_VERSION"

          # Verify they match
          if [ "$GIT_TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ERROR: Version mismatch!"
            echo "Git tag: v$GIT_TAG_VERSION"
            echo "package.json: $PACKAGE_VERSION"
            echo "These must match. The git tag is the source of truth."
            exit 1
          fi

          echo "âœ… Versions match: $PACKAGE_VERSION"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Determine npm dist-tag
        id: dist_tag
        run: |
          VERSION=$(node -p "require('./packages/cache-handler/package.json').version")
          if [[ "$VERSION" == *"-alpha"* ]]; then
            echo "tag=alpha" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-beta"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-rc"* ]]; then
            echo "tag=rc" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          echo "Publishing with tag: $(cat $GITHUB_OUTPUT | grep tag= | cut -d= -f2)"

      - name: Publish to npm
        working-directory: packages/cache-handler
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --tag ${{ steps.dist_tag.outputs.tag }}

      - name: Verify published
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/cache-handler/package.json').version")
          DIST_TAG="${{ steps.dist_tag.outputs.tag }}"
          echo "âœ… Published @mrjasonroy/cache-components-cache-handler@$PACKAGE_VERSION"
          echo "ðŸ“¦ npm dist-tag: $DIST_TAG"
          npm view @mrjasonroy/cache-components-cache-handler@$PACKAGE_VERSION

      - name: Update release with npm info
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(node -p "require('./packages/cache-handler/package.json').version")
          DIST_TAG="${{ steps.dist_tag.outputs.tag }}"
          TAG="v${VERSION}"

          INSTALL_CMD="npm install @mrjasonroy/cache-components-cache-handler@${VERSION}"
          if [[ "$DIST_TAG" != "latest" ]]; then
            INSTALL_CMD="${INSTALL_CMD}\n# Or install by tag:\nnpm install @mrjasonroy/cache-components-cache-handler@${DIST_TAG}"
          fi

          COMMENT="âœ… Successfully published to npm!

ðŸ“¦ **dist-tag:** \`${DIST_TAG}\`

\`\`\`bash
${INSTALL_CMD}
\`\`\`

View on npm: https://www.npmjs.com/package/@mrjasonroy/cache-components-cache-handler/v/${VERSION}"

          # Add comment to release discussion
          gh release view "$TAG" --json body --jq .body > /tmp/release-body.md
          echo "" >> /tmp/release-body.md
          echo "---" >> /tmp/release-body.md
          echo "" >> /tmp/release-body.md
          echo "$COMMENT" >> /tmp/release-body.md
          gh release edit "$TAG" --notes-file /tmp/release-body.md

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          DIST_TAG="${{ steps.dist_tag.outputs.tag }}"

          # Determine if pre-release
          PRERELEASE_FLAG=""
          TITLE="$TAG"
          if [[ "$VERSION" == *"-alpha"* ]]; then
            PRERELEASE_FLAG="--prerelease"
            TITLE="$TAG (Alpha)"
          elif [[ "$VERSION" == *"-beta"* ]]; then
            PRERELEASE_FLAG="--prerelease"
            TITLE="$TAG (Beta)"
          elif [[ "$VERSION" == *"-rc"* ]]; then
            PRERELEASE_FLAG="--prerelease"
            TITLE="$TAG (Release Candidate)"
          fi

          # Generate release notes using GitHub API
          GENERATED_NOTES=$(gh api repos/${{ github.repository }}/releases/generate-notes \
            -f tag_name="$TAG" \
            --jq '.body')

          # Create release notes with installation instructions + auto-generated notes
          RELEASE_NOTES=$(cat <<EOF
          ## Installation

          \`\`\`bash
          npm install @mrjasonroy/cache-components-cache-handler@$VERSION
          \`\`\`

          **npm dist-tag:** \`$DIST_TAG\`

          ---

          $GENERATED_NOTES
          EOF
          )

          # Create release
          gh release create "$TAG" \
            --title "$TITLE" \
            --notes "$RELEASE_NOTES" \
            $PRERELEASE_FLAG

          echo "âœ… Created GitHub release for $TAG"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/$TAG"
