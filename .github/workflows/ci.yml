name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

      - name: Format check
        run: pnpm biome check --formatter-enabled=true --linter-enabled=false .

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Run unit tests
        run: pnpm test

  e2e-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - backend: memory
            cache_handler: memory
            service_image: ""
            redis_url: ""

          - backend: redis
            cache_handler: redis
            service_image: redis:7-alpine
            redis_url: redis://localhost:6379

          - backend: valkey
            cache_handler: redis
            service_image: valkey/valkey:7-alpine
            redis_url: redis://localhost:6379

    services:
      cache-service:
        image: ${{ matrix.service_image || 'alpine:latest' }}
        ports:
          - 6379:6379
        options: >-
          ${{ matrix.service_image && contains(matrix.service_image, 'redis') && '--health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5' || '' }}
          ${{ matrix.service_image && contains(matrix.service_image, 'valkey') && '--health-cmd "valkey-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5' || '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Install Playwright browsers
        run: pnpm --filter e2e-test-app exec playwright install --with-deps chromium

      - name: Build e2e app
        env:
          CACHE_HANDLER: ${{ matrix.cache_handler }}
          REDIS_URL: ${{ matrix.redis_url }}
        run: |
          cd apps/e2e-test-app
          pnpm build

      - name: Run e2e tests
        env:
          CACHE_HANDLER: ${{ matrix.cache_handler }}
          REDIS_URL: ${{ matrix.redis_url }}
        run: |
          cd apps/e2e-test-app
          pnpm test:e2e

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.backend }}
          path: apps/e2e-test-app/test-results/
          retention-days: 7
          if-no-files-found: ignore

  e2e-elasticache:
    runs-on: ubuntu-latest
    needs: unit-tests
    # Test ElastiCache handler code path using Redis container
    # This validates the ElastiCache configuration without requiring actual AWS infrastructure
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Install Playwright browsers
        run: pnpm --filter e2e-test-app exec playwright install --with-deps chromium

      - name: Build e2e app with ElastiCache handler
        env:
          CACHE_HANDLER: elasticache
          ELASTICACHE_ENDPOINT: localhost
          ELASTICACHE_PORT: "6379"
          ELASTICACHE_TLS: "false"
        run: |
          cd apps/e2e-test-app
          pnpm build

      - name: Run e2e tests with ElastiCache handler
        env:
          CACHE_HANDLER: elasticache
          ELASTICACHE_ENDPOINT: localhost
          ELASTICACHE_PORT: "6379"
          ELASTICACHE_TLS: "false"
        run: |
          cd apps/e2e-test-app
          pnpm test:e2e

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-elasticache
          path: apps/e2e-test-app/test-results/
          retention-days: 7
          if-no-files-found: ignore

  test-summary:
    runs-on: ubuntu-latest
    needs: [e2e-tests, e2e-elasticache]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "E2E Matrix Tests: ${{ needs.e2e-tests.result }}"
          echo "ElastiCache Tests: ${{ needs.e2e-elasticache.result }}"

          E2E_RESULT="${{ needs.e2e-tests.result }}"
          ELASTICACHE_RESULT="${{ needs.e2e-elasticache.result }}"

          # Accept both 'success' and 'skipped' as valid results
          if [[ "$E2E_RESULT" != "success" && "$E2E_RESULT" != "skipped" ]] || \
             [[ "$ELASTICACHE_RESULT" != "success" && "$ELASTICACHE_RESULT" != "skipped" ]]; then
            echo "❌ Some tests failed"
            exit 1
          fi

          echo "✅ All tests passed (memory, redis, valkey, elasticache)!"
